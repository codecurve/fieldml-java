<fieldml>
  <!-- 
  
  Mixed-geometry mesh:
  
  9---7---1---2---6
  |   |   |   |\ 3|
  | 5 | 4 | 1 |2\ |
  |   |   |   |  \|
  10--8---3---4---5
  
  
  Quad-refinement mesh:
  
  1---5---2
  |   |   |
  | 1 | 2 |
  |   |   |
  6---7---8
  |   |   |
  | 3 | 4 |
  |   |   |
  4---9---3  
  
  
   -->

  <!--
     Mapped fields can be defined over an implicit index-valued ensemble, starting from 1, with the
     given cardinality. This allows them to be used hierarchically, with the parent supplying it
     with an ensemble constructed from the parent's own context. 
   -->
  
  <!--
     For now, all values in a shape map must have the same dimensionality. This is enforced by
     specifying the relevant value domain. 
   -->
  <mapped_field elements="5" id="test_mesh.shapes" value_domain="library::2d_shapes">
    <elements>
      1  4  5
      <constant_value value="library::unit_square" />
    </elements>
    <elements>
      2  3
      <constant_value value="library::unit_triangle" />
    </elements>
  </mapped_field>
  
  <mapped_field elements="4" id="quad_mesh.shapes" value_domain="library::2d_shapes">
    <elements>
      1  2  3  4
      <constant_value value="library::unit_square" />
    </elements>
  </mapped_field>
  
  <!--
    Generates an output dof-vector based on an input dof vector via a matrix.
   -->
  <dof_generator_linear name="quad_refinement_dofs" input_elements="4" output_elements="9">
    <row>
      1   0   0   0
    </row>
    <row>
      0   1   0   0
    </row>
    <row>
      0   0   1   0
    </row>
    <row>
      0   0   0   1
    </row>
    <row>
      0.5 0.5 0   0
    </row>
    <row>
      0.5 0   0   0.5
    </row>
    <row>
      0.5 0.5 0.5 0.5
    </row>
    <row>
      0   0.5 0.5 0
    </row>
    <row>
      0   0   0.5 0.5
    </row>
  </dof_generator_linear>
  

  <!--
     The shapes and nodes fields must have the same ensemble cardinality
   -->
  <simple_mesh id="mesh1" element_shapes="test_mesh.shapes" nodes="mesh.element_nodes" dimensions="2" />
  
  <simple_mesh id="mesh_refinement.quad" element_shapes="quad_mesh.shapes" nodes="mesh.element_nodes" dimensions="2" />
  
  <!--
    Construct a 2x2 quad mesh with explicit connectivity. 
   -->
  <complex_mesh id="mesh2" dimensions="2">
    <element index="1" shape="library::unit_square" />
    <element index="2" shape="library::unit_square" />
    <element index="3" shape="library::unit_square" />
    <element index="4" shape="library::unit_square" />
    
    <!--
      Some of these are redundant. e.g. A<->B, B<->C implies A<->C 
     -->
    <connect element1="1" xi1="0,0" element2="3" xi2="0,1" />
    <connect element1="1" xi1="1,0" element2="2" xi2="0,0" />
    <connect element1="1" xi1="1,0" element2="3" xi2="1,1" />
    <connect element1="1" xi1="1,0" element2="4" xi2="1,0" />
    <connect element1="1" xi1="1,1" element2="2" xi2="0,1" />
    <connect element1="2" xi1="1,0" element2="4" xi2="1,1" />
    <connect element1="2" xi1="0,0" element2="3" xi2="1,1" />
    <connect element1="2" xi1="0,0" element2="4" xi2="0,1" />
    <connect element1="3" xi1="1,0" element2="4" xi2="0,0" />
    <connect element1="3" xi1="1,1" element2="4" xi2="0,1" />
  </complex_mesh>

  <piecewise_field id="mesh.coordinates" mesh="mesh1" value_domain="library::cartesian_2d">
    <evaluate_piecewise component="x" dofs="global.mesh.x">
      <elements>  1  4
        <import_value field="library::bilinear_lagrange">
          <dofs component="u">
            <generate_dofs generator="library::direct_dof_generator">
              <!--
                The element passed to the given field is the element being evaluated 
               -->
              <import_indexes field="mesh1.node_list" />
            </generate_dofs>
          </dofs>
        </import_value>
      </elements>
      <elements>  2
        <import_value field="library::bilinear_simplex">
          <dofs component="u">
            <generate_dofs generator="library::direct_dof_generator">
              <!--
                The element passed to the given field is the element being evaluated 
               -->
              <import_indexes field="mesh1.node_list" />
            </generate_dofs>
          </dofs>
        </import_value>
      </elements>
      <elements>  3
        <constant_value value="0.0" />
      </elements>
      <elements>  5
        <import_value field="mesh.quad_field">
          <dofs component="u">
            <generate_dofs generator="quad_refinement_dofs">
              <import_indexes field="mesh1.node_list" />
            </generate_dofs>
            <!--
              How do we turn the xi into an element-xi pair for the refined mesh? 
             -->
          </dofs>
        </import_value>
      </elements>
    </evaluate_piecewise>
  </piecewise_field>
  
  <piecewise_field id="mesh.quad_field" mesh="mesh_refinement.quad" value_domain="library::real">
    <evaluate_piecewise component="u">
      <elements>  1  2  3  4
        <interpolate_value element_dof_indexes="mesh_refinement.quad_node_list" interpolation="library::bilinear_lagrange" />
      </elements>
    </evaluate_piecewise>
  </piecewise_field>
  
  <piecewise_field elements="5" id="mesh1.node_list" value_domain="library::index_vector">
    <evaluate_piecewise>
      <elements> 1
        <constant_value>
          1  2  4  3
        </constant_value>
      </elements>
      <elements> 2
        <constant_value>
          2  4  5
        </constant_value>
      </elements>
      <elements> 3
        <constant_value>
          2  5  6
        </constant_value>
      </elements>
      <elements> 4
        <constant_value>
          7  1  3  8
        </constant_value>
      </elements>
      <elements> 5
        <constant_value>
          9  7  8  10
        </constant_value>
      </elements>
    </evaluate_piecewise>
  </piecewise_field>

  <piecewise_field elements="4" id="mesh_refinement.quad_node_list" value_domain="library::index_vector">
    <evaluate_piecewise>
      <elements> 1
        <constant_value>
          1  5  7  6
        </constant_value>
      </elements>
      <elements> 2
        <constant_value>
          5  2  8  7
        </constant_value>
      </elements>
      <elements> 3
        <constant_value>
          7  8  3  9
        </constant_value>
      </elements>
      <elements> 4
        <constant_value>
          6  7  9  4
        </constant_value>
      </elements>
    </evaluate_piecewise>
  </piecewise_field>

  <global_dof_list id="global.mesh.x">
    0.0  1.0  0.0  1.0  2.0  2.0 -1.0 -1.0
  </global_dof_list>

  <global_dof_list id="global.mesh.y">
    1.0  1.0  0.0  0.0  0.0  1.0  1.0  0.0
  </global_dof_list>
</fieldml>
